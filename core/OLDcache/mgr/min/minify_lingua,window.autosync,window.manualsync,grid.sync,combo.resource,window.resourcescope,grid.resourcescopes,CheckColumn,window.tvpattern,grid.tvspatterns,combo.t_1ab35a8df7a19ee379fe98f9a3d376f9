var Lingua=function(config){config=config||{};Lingua.superclass.constructor.call(this,config);};Ext.extend(Lingua,Ext.Component,{page:{},window:{},grid:{},tree:{},panel:{},combo:{},config:{}});Ext.reg('lingua',Lingua);Lingua=new Lingua();;Lingua.window.AutoSync=function(config){config=config||{};var items=[];if(typeof(config.contexts)!=='undefined'&&config.contexts.length>0){Ext.each(config.contexts,function(item){items.push({boxLabel:item.name||item.key,name:'contexts[]',inputValue:item.key});});}
Ext.applyIf(config,{url:Lingua.config.connectorUrl,closeAction:'close',fields:[{xtype:'checkboxgroup',fieldLabel:_('contexts'),items:items}]});Lingua.window.AutoSync.superclass.constructor.call(this,config);};Ext.extend(Lingua.window.AutoSync,MODx.Window);Ext.reg('lingua-window-autosync',Lingua.window.AutoSync);;Lingua.window.ManualSync=function(config){config=config||{};var win=this;Ext.applyIf(config,{closeAction:'close',fields:[{xtype:'hidden',name:'resource_id'},{xtype:'lingua-combo-resource',name:'pagetitle',formpanel:this.getId()},{xtype:'modx-combo',fieldLabel:_('lingua....or')+' '+_('lingua.pagetitle_of_target'),name:'page_id',anchor:'100%',url:Lingua.config.connectorUrl,baseParams:{action:'mgr/resource/getlist',combo:true},displayField:'pagetitle',valueField:'id',fields:['id','pagetitle'],editable:true,typeAhead:true,forceSelection:false,listeners:{select:{fn:function(combo,record,index){if(combo.getValue()===""||combo.getValue()===0||combo.getValue()==="&nbsp;"){combo.setValue(null);}else{win.fp.getForm().findField('resource_id').setValue(record.id);}
win.fp.getForm().findField('pagetitle').reset();},scope:this},blur:{fn:function(combo){if(combo.getValue()===""||combo.getValue()===0||combo.getValue()==="&nbsp;"){combo.setValue(null);}},scope:this}}}],buttons:[{text:_('cancel'),scope:this,handler:this.close},{text:_('add'),cls:'primary-button',scope:this,handler:function(){this.addResourceToGrid();this.close();}}]});Lingua.window.ManualSync.superclass.constructor.call(this,config);};Ext.extend(Lingua.window.ManualSync,MODx.Window,{addResourceToGrid:function(){var values=this.fp.getForm().getValues();var records=this.grid.getStore().getRange();var newData=[];Ext.each(records,function(record){newData.push([record.data.id,record.data.pagetitle]);});newData.push([values.resource_id,values.pagetitle||values.page_id]);this.grid.getStore().loadData(newData);this.grid.getView().refresh();}});Ext.reg('lingua-window-manualsync',Lingua.window.ManualSync);;Lingua.grid.Sync=function(config){config=config||{};Ext.applyIf(config,{id:'lingua-grid-sync',fields:['id','pagetitle'],autoExpandColumn:'pagetitle',autoHeight:true,columns:[{header:_('id'),dataIndex:'id',sortable:true,width:40,hidden:false,fixed:true},{header:_('pagetitle'),dataIndex:'pagetitle',sortable:true}],tbar:[{text:_('lingua.auto_sync'),scope:this,handler:this.autoSync}],bbar:['->',{text:_('add'),scope:this,handler:this.addManualResource},{text:_('lingua.manual_sync'),scope:this,handler:this.manualSync}]});Lingua.grid.Sync.superclass.constructor.call(this,config);};Ext.extend(Lingua.grid.Sync,MODx.grid.LocalGrid,{getMenu:function(){var menu=[{text:_('delete'),handler:this.removeResource}];return menu;},removeResource:function(){this.getStore().remove(this.getSelectionModel().getSelections()[0]);this.getView().refresh();},autoSync:function(){var _this=this;_this._loadMask();MODx.Ajax.request({url:Lingua.config.connectorUrl,params:{action:'mgr/contexts/getlist',},listeners:{'success':{fn:function(response){if(response.success){_this.autoSyncWin(response.results);}}},'failure':{fn:function(response){if(typeof(response.message)!=='undefined'){MODx.msg.alert(_('error'),response.message,Ext.emptyFn);}
_this._hideMask();}}}});},autoSyncWin:function(contexts){var _this=this;var win=new Lingua.window.AutoSync({title:_('lingua.auto_sync'),contexts:contexts,baseParams:{action:'mgr/tools/autosync',limit:20,start:0},listeners:{'success':{fn:function(r){var response=r.a.result;if(response.success){var total=response.total-0;if(total>response.object.nextStart){_this.autoSyncLoop(20,response.object.nextStart);}else{_this._hideMask();MODx.msg.alert(_('success'),response.message||'',Ext.emptyFn);}}}},'failure':{fn:function(response){if(typeof(response.message)!=='undefined'){MODx.msg.alert(_('error'),response.message,Ext.emptyFn);}
_this._hideMask();}}}});win.on('close',function(){_this._hideMask();});win.show();},autoSyncLoop:function(limit,start){var _this=this;MODx.Ajax.request({url:Lingua.config.connectorUrl,params:{action:'mgr/tools/autosync',limit:(limit?limit:20),start:(start?start:0)},listeners:{'success':{fn:function(response){if(response.success){var total=response.total-0;if(total>response.nextStart){_this.autoSyncLoop(limit,response.nextStart);}else{_this._hideMask();}}}},'failure':{fn:function(response){if(typeof(response.message)!=='undefined'){MODx.msg.alert(_('error'),response.message,Ext.emptyFn);}
_this._hideMask();}}}});},_loadMask:function(){if(!this.loadToolMask){this.loadToolMask=new Ext.LoadMask(Ext.getBody().dom,{msg:_('lingua.please_wait')});}
this.loadToolMask.show();},_hideMask:function(){if(this.loadToolMask){this.loadToolMask.hide();}},addManualResource:function(){var win=MODx.load({title:_('add'),xtype:'lingua-window-manualsync',grid:this});win.reset();win.show();},manualSync:function(){var records=this.getStore().getRange();var res=[];Ext.each(records,function(record){res.push(record.data.id);});if(res.length===0){MODx.msg.alert(_('error'),_('lingua.manual_sync_err_ns'),Ext.emptyFn);return false;}
this._loadMask();this.manualSyncLoop(20,0,res);},manualSyncLoop:function(limit,start,ids){var _this=this;MODx.Ajax.request({url:Lingua.config.connectorUrl,params:{action:'mgr/tools/manualsync',limit:(limit?limit:20),start:(start?start:0),ids:JSON.stringify(ids)},listeners:{'success':{fn:function(response){if(response.success){var total=response.total-0;if(total>response.nextStart){_this.manualSyncLoop(limit,response.nextStart,ids);}else{_this._hideMask();_this.getStore().loadData([]);_this.getView().refresh();MODx.msg.alert(_('success'),response.message||'',Ext.emptyFn);}}}},'failure':{fn:function(response){if(typeof(response.message)!=='undefined'){MODx.msg.alert(_('error'),response.message,Ext.emptyFn);}
_this._hideMask();}}}});}});Ext.reg('lingua-grid-sync',Lingua.grid.Sync);;Lingua.combo.Resource=function(config){config=config||{};Ext.applyIf(config,{fieldLabel:_('resource'),id:'',width:370});Lingua.combo.Resource.superclass.constructor.call(this,config);};Ext.extend(Lingua.combo.Resource,MODx.ChangeParentField,{end:function(p){var t=Ext.getCmp('modx-resource-tree');if(!t)
return;p.d=p.d||p.v;t.removeListener('click',this.handleChangeParent,this);t.on('click',t._handleClick,t);t.disableHref=false;Ext.getCmp(this.config.formpanel).fp.getForm().findField('resource_id').setValue(p.v);Ext.getCmp(this.config.formpanel).fp.getForm().findField('page_id').setValue(null);this.setValue(p.d);this.oldValue=false;},disableTreeClick:function(){MODx.debug('Disabling tree click');var t=Ext.getCmp('modx-resource-tree');if(!t){MODx.debug('No tree found in disableTreeClick!');return false;}
this.oldDisplayValue=this.getValue();this.oldValue=this.config.oldValue||'';this.setValue(_('resource_parent_select_node'));t.expand();t.removeListener('click',t._handleClick);t.on('click',this.handleChangeParent,this);t.disableHref=true;return true;}});Ext.reg('lingua-combo-resource',Lingua.combo.Resource);;Lingua.window.ResourceScope=function(config){config=config||{};var fields=[];if(typeof(config.baseParams.id)!=='undefined'&&config.baseParams.id>0){}else{fields.push({xtype:'hidden',name:'id'},{xtype:'hidden',name:'resource_id'},{xtype:'lingua-combo-resource',name:'resource-combo',formpanel:this.getId()});}
fields.push({xtype:'textarea',fieldLabel:_('properties'),name:'properties',anchor:'100%',hidden:true});fields.push({xtype:'textfield',fieldLabel:_('lingua.languages'),description:_('lingua.languages_field_desc'),name:'property_langs',anchor:'100%'});fields.push({xtype:'xcheckbox',boxLabel:_('lingua.as_parent'),name:'as_parent'});fields.push({xtype:'xcheckbox',boxLabel:_('lingua.as_ancestor'),name:'as_ancestor'});fields.push({xtype:'xcheckbox',boxLabel:_('lingua.exclude_self'),name:'exclude_self'});Ext.applyIf(config,{url:Lingua.config.connectorUrl,fields:fields});Lingua.window.ResourceScope.superclass.constructor.call(this,config);};Ext.extend(Lingua.window.ResourceScope,MODx.Window);Ext.reg('lingua-window-resourcescope',Lingua.window.ResourceScope);;Lingua.grid.ResourceScopes=function(config){config=config||{};Ext.applyIf(config,{id:'lingua-grid-resourcescopes',url:Lingua.config.connectorUrl,baseParams:{action:'mgr/resourcescopes/getList'},fields:['id','resource_id','pagetitle','properties','property_langs','as_parent','as_ancestor','exclude_self'],paging:true,remoteSort:true,anchor:'97%',autoExpandColumn:'pagetitle',columns:[{header:_('id'),dataIndex:'id',sortable:true,hidden:true,width:40},{header:_('id'),dataIndex:'resource_id',width:40,sortable:true},{header:_('pagetitle'),dataIndex:'pagetitle',sortable:true},{header:_('properties'),dataIndex:'properties',sortable:false,editor:{xtype:'textarea'}},{xtype:'checkcolumn',header:_('parent'),tooltip:_('lingua.as_parent'),dataIndex:'as_parent',width:80,fixed:true,sortable:false,processEvent:this.processCheckColumn},{xtype:'checkcolumn',header:_('lingua.as_ancestor'),tooltip:_('lingua.as_ancestor_desc'),dataIndex:'as_ancestor',width:100,fixed:true,sortable:false,processEvent:this.processCheckColumn},{xtype:'checkcolumn',header:_('lingua.exclude_self'),tooltip:_('lingua.exclude_self_desc'),dataIndex:'exclude_self',width:100,fixed:true,sortable:false,processEvent:this.processCheckColumn}],tbar:[{text:_('add'),handler:{xtype:'lingua-window-resourcescope',title:_('lingua.resourcescope_create'),baseParams:{action:'mgr/resourcescopes/create'},blankValues:true}},'->',{xtype:'textfield',id:'scopes-search-filter',emptyText:_('lingua.search...'),listeners:{'change':{fn:this.search,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this);this.blur();return true;},scope:cmp});},scope:this}}}]});Lingua.grid.ResourceScopes.superclass.constructor.call(this,config);};Ext.extend(Lingua.grid.ResourceScopes,MODx.grid.Grid,{search:function(tf,nv,ov){var s=this.getStore();s.baseParams.query=tf.getValue();this.getBottomToolbar().changePage(1);this.refresh();},getMenu:function(){return[{text:_('lingua.update'),handler:this.updateResourceScope},'-',{text:_('lingua.delete'),handler:this.removeResourceScope}];},processCheckColumn:function(name,e,grid,rowIndex,colIndex){if(name==='mousedown'){var record=grid.store.getAt(rowIndex);record.set(this.dataIndex,!record.data[this.dataIndex]);MODx.Ajax.request({url:Lingua.config.connectorUrl,params:{action:'mgr/resourcescopes/updateFromGrid',data:JSON.stringify(record.data)},listeners:{'success':{fn:function(){Ext.getCmp('lingua-grid-resourcescopes').refresh();}}}});return false;}else{return Ext.grid.ActionColumn.superclass.processEvent.apply(this,arguments);}},updateResourceScope:function(e){var updateResourceScopeWindow=MODx.load({xtype:'lingua-window-resourcescope',title:_('lingua.update'),baseParams:{action:'mgr/resourcescopes/update',id:this.menu.record.id},closeAction:'close',listeners:{'success':{fn:this.refresh,scope:this}}});updateResourceScopeWindow.setValues(this.menu.record);updateResourceScopeWindow.show(e.target);},removeResourceScope:function(){MODx.msg.confirm({title:_('lingua.delete'),text:_('lingua.delete_resourcescope_confirm'),url:this.config.url,params:{action:'mgr/resourcescopes/remove',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});}});Ext.reg('lingua-grid-resourcescopes',Lingua.grid.ResourceScopes);;
/*!
 * Ext JS Library 3.4.0
 * Copyright(c) 2006-2011 Sencha Inc.
 * licensing@sencha.com
 * http://www.sencha.com/license
 */
Ext.ns('Ext.ux.grid');Ext.ux.grid.CheckColumn=Ext.extend(Ext.grid.Column,{processEvent:function(name,e,grid,rowIndex,colIndex){if(name=='mousedown'){var record=grid.store.getAt(rowIndex);record.set(this.dataIndex,!record.data[this.dataIndex]);return false;}else{return Ext.grid.ActionColumn.superclass.processEvent.apply(this,arguments);}},renderer:function(v,p,record){p.css+=' x-grid3-check-col-td';return String.format('<div class="x-grid3-check-col{0}">&#160;</div>',v?'-on':'');},init:Ext.emptyFn});Ext.preg('checkcolumn',Ext.ux.grid.CheckColumn);Ext.grid.CheckColumn=Ext.ux.grid.CheckColumn;Ext.grid.Column.types.checkcolumn=Ext.ux.grid.CheckColumn;;Lingua.window.TVPattern=function(config){config=config||{};Ext.applyIf(config,{url:Lingua.config.connectorUrl,labelAlign:'left',width:600,fields:[{fieldLabel:_('type'),xtype:'textfield',name:'type',anchor:'100%'},{fieldLabel:_('search'),xtype:'textarea',name:'search',anchor:'100%'},{fieldLabel:_('lingua.replacement'),xtype:'textarea',name:'replacement',anchor:'100%'}],keys:[{key:[Ext.EventObject.ENTER],handler:function(keyCode,event){var elem=event.getTarget();var component=Ext.getCmp(elem.id);if(component instanceof Ext.form.TextArea){return component.append("\n");}else if(!this.fp.getForm().isValid()){return;}else{this.submit();}},scope:this}]});Lingua.window.TVPattern.superclass.constructor.call(this,config);};Ext.extend(Lingua.window.TVPattern,MODx.Window);Ext.reg('lingua-window-tvpattern',Lingua.window.TVPattern);;Lingua.grid.TVsPatterns=function(config){config=config||{};Ext.applyIf(config,{id:'lingua-grid-tvspatterns',url:Lingua.config.connectorUrl,baseParams:{action:'mgr/tvpatterns/getList'},fields:['id','type','search','replacement'],paging:true,remoteSort:true,anchor:'97%',save_action:'mgr/tvpatterns/updateFromGrid',autosave:true,autoExpandColumn:'search',columns:[{header:_('id'),dataIndex:'id',sortable:true,hidden:true,width:40},{header:_('type'),dataIndex:'type',sortable:true,editor:{xtype:'textfield'}},{header:_('search'),dataIndex:'search',sortable:true,editor:{xtype:'textarea'}},{header:_('lingua.replacement'),dataIndex:'replacement',sortable:true,editor:{xtype:'textarea'}}],tbar:[{text:_('lingua.add_pattern'),handler:{xtype:'lingua-window-tvpattern',title:_('lingua.add_pattern'),baseParams:{action:'mgr/tvpatterns/create'},blankValues:true}},'->',{xtype:'textfield',emptyText:_('lingua.search...'),listeners:{'change':{fn:this.search,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this);this.blur();return true;},scope:cmp});},scope:this}}}]});Lingua.grid.TVsPatterns.superclass.constructor.call(this,config);};Ext.extend(Lingua.grid.TVsPatterns,MODx.grid.Grid,{search:function(tf,nv,ov){var s=this.getStore();s.baseParams.query=tf.getValue();this.getBottomToolbar().changePage(1);this.refresh();},getMenu:function(){return[{text:_('lingua.update'),handler:this.updatePattern},{text:_('duplicate'),handler:this.duplicatePattern},'-',{text:_('lingua.delete'),handler:this.removePattern}];},updatePattern:function(btn,e){if(!this.updatePatternWindow){this.updatePatternWindow=MODx.load({xtype:'lingua-window-tvpattern',title:_('lingua.update'),baseParams:{action:'mgr/tvpatterns/update'},listeners:{'success':{fn:this.refresh,scope:this}}});}
this.updatePatternWindow.baseParams['id']=this.menu.record.id;this.updatePatternWindow.setValues(this.menu.record);this.updatePatternWindow.show(e.target);},duplicatePattern:function(btn,e){if(!this.duplicatePatternWindow){this.duplicatePatternWindow=MODx.load({xtype:'lingua-window-tvpattern',title:_('duplicate'),baseParams:{action:'mgr/tvpatterns/create'},listeners:{'success':{fn:this.refresh,scope:this}}});}
var values=this.menu.record;delete(values['id']);this.duplicatePatternWindow.setValues(values);this.duplicatePatternWindow.show(e.target);},removePattern:function(){MODx.msg.confirm({title:_('lingua.delete'),text:_('lingua.delete_lang_confirm'),url:this.config.url,params:{action:'mgr/tvpatterns/remove',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});}});Ext.reg('lingua-grid-tvspatterns',Lingua.grid.TVsPatterns);;Lingua.combo.TV=function(config){config=config||{};Ext.applyIf(config,{url:Lingua.config.connectorUrl,baseParams:{action:'mgr/tv/combogetlist',excludeExisting:1},width:300,pageSize:10,typeAhead:true,editable:true,forceSelection:true,minChars:1,triggerAction:'all',lazyRender:true,fields:['id','name'],name:'tmplvarid',hiddenName:'tmplvarid',displayField:'name',valueField:'id'});Lingua.combo.TV.superclass.constructor.call(this,config);};Ext.extend(Lingua.combo.TV,MODx.combo.ComboBox);Ext.reg('lingua-combo-tv',Lingua.combo.TV);